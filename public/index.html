<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Upload & Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            color: #667eea;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: #999;
            font-size: 14px;
        }

        input[type="file"] {
            display: none;
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #e8f5e9;
            border-radius: 10px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            color: #2e7d32;
            font-weight: 600;
            word-break: break-all;
        }

        .upload-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            display: none;
        }

        .upload-btn.show {
            display: block;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .upload-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .results.show {
            display: block;
        }

        /* Decision Banner */
        .decision-banner {
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .decision-banner.accept {
            background: linear-gradient(135deg, #4caf50 0%, #66bb6a 100%);
            color: white;
        }

        .decision-banner.review {
            background: linear-gradient(135deg, #ff9800 0%, #ffa726 100%);
            color: white;
        }

        .decision-banner.reject {
            background: linear-gradient(135deg, #f44336 0%, #ef5350 100%);
            color: white;
        }

        .decision-title {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .decision-subtitle {
            font-size: 16px;
            opacity: 0.95;
            margin-bottom: 20px;
        }

        .risk-score-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .score-item {
            background: rgba(255,255,255,0.2);
            padding: 15px 25px;
            border-radius: 10px;
        }

        .score-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 24px;
            font-weight: bold;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
            margin-bottom: 5px;
        }

        .badge.high {
            background: #ffebee;
            color: #c62828;
        }

        .badge.medium {
            background: #fff3e0;
            color: #e65100;
        }

        .badge.low {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge.info {
            background: #e3f2fd;
            color: #1565c0;
        }

        /* Indicators */
        .indicator-card {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 8px;
        }

        .indicator-card.high {
            border-left-color: #f44336;
            background: #ffebee;
        }

        .indicator-card.medium {
            border-left-color: #ff9800;
            background: #fff3e0;
        }

        .indicator-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .indicator-title {
            font-weight: 600;
            color: #333;
        }

        .indicator-details {
            color: #666;
            font-size: 14px;
            margin-top: 8px;
        }

        /* Progress bars */
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 12px;
            font-weight: 600;
        }

        /* Expandable sections */
        .expandable {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .expandable-header {
            background: #f8f9fa;
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            transition: background 0.2s;
        }

        .expandable-header:hover {
            background: #e9ecef;
        }

        .expandable-icon {
            transition: transform 0.3s;
        }

        .expandable-header.active .expandable-icon {
            transform: rotate(180deg);
        }

        .expandable-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .expandable-content.active {
            max-height: 2000px;
            padding: 15px;
        }

        /* Grid layout */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
            word-break: break-all;
        }

        /* Visualizations */
        .viz-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .viz-item {
            text-align: center;
        }

        .viz-item img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .viz-label {
            margin-top: 10px;
            font-weight: 600;
            color: #666;
        }

        /* Hash display */
        .hash-container {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
        }

        .error {
            background: #ffebee;
            border: 2px solid #ef5350;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .reset-btn {
            width: 100%;
            padding: 12px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÅ File Analysis Tool</h1>
        <p class="subtitle">Upload PDF, PNG, or JPEG files for analysis</p>

        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üì§</div>
            <div class="upload-text">Click to upload or drag and drop</div>
            <div class="upload-hint">Supported formats: PDF, PNG, JPEG (Max 10MB)</div>
            <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg">
        </div>

        <div class="file-info" id="fileInfo">
            <div>Selected file: <span class="file-name" id="fileName"></span></div>
        </div>

        <button class="upload-btn" id="uploadBtn">Analyze File</button>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div>Analyzing your file...</div>
        </div>

        <div class="error" id="error"></div>

        <div class="results" id="results">
            <div id="resultsContent"></div>
            <button class="reset-btn" onclick="resetForm()">Upload Another File</button>
        </div>
    </div>

    <script>
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const uploadBtn = document.getElementById('uploadBtn');
        const loading = document.getElementById('loading');
        const error = document.getElementById('error');
        const results = document.getElementById('results');
        const resultsContent = document.getElementById('resultsContent');

        let selectedFile = null;

        // Click to upload
        uploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        // File selection
        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        // Drag and drop
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            if (!file) return;

            // Validate file type
            const allowedTypes = ['application/pdf', 'image/png', 'image/jpeg'];
            if (!allowedTypes.includes(file.type)) {
                showError('Invalid file type. Please upload PDF, PNG, or JPEG files only.');
                return;
            }

            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showError('File size exceeds 10MB limit.');
                return;
            }

            selectedFile = file;
            fileName.textContent = file.name;
            fileInfo.classList.add('show');
            uploadBtn.classList.add('show');
            hideError();
            hideResults();
        }

        uploadBtn.addEventListener('click', async () => {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);

            uploadBtn.disabled = true;
            loading.classList.add('show');
            hideError();
            hideResults();

            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                // Read response body once (can only be read once!)
                const responseText = await response.text();
                console.log('Response received, size:', responseText.length, 'bytes');

                // Check response status and handle errors
                if (!response.ok) {
                    let errorMessage = `Server error (${response.status})`;
                    try {
                        const errorData = JSON.parse(responseText);
                        errorMessage = errorData.error || errorData.details || errorMessage;
                    } catch (e) {
                        // If JSON parsing fails, use raw text
                        errorMessage = responseText.substring(0, 200) || errorMessage;
                    }
                    throw new Error(errorMessage);
                }

                // Parse JSON with error handling
                let data;
                try {
                    data = JSON.parse(responseText);
                    console.log('JSON parsed successfully');
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response preview:', responseText.substring(0, 500));
                    throw new Error('Failed to parse server response. The response may be incomplete or corrupted.');
                }

                // Render results with error handling
                try {
                    showResults(data);
                } catch (renderError) {
                    console.error('Render error:', renderError);
                    console.error('Error stack:', renderError.stack);
                    throw new Error('Failed to display results: ' + renderError.message);
                }
            } catch (err) {
                console.error('Upload error:', err);
                showError('Error: ' + err.message);
            } finally {
                uploadBtn.disabled = false;
                loading.classList.remove('show');
            }
        });

        function showResults(data) {
            console.log('showResults called with data:', data);

            const result = data.result;
            if (!result) {
                console.warn('No result in data');
                resultsContent.innerHTML = '<div class="card"><p>No analysis results available</p></div>';
                results.classList.add('show');
                return;
            }

            console.log('Result keys:', Object.keys(result));
            let html = '';

            // 1. Visualizations First (Priority-based)
            const documentFormat = result.routing?.document_format || '';
            const isPDF = documentFormat.startsWith('PDF_');

            if (result.forensics && result.forensics.forensic_analysis) {
                let visualizationHtml = '';
                let visualizationTitle = '';

                if (isPDF) {
                    // PDF: Priority 1 - Visual proofs from pdf_structure
                    const pdfStructure = result.forensics.forensic_analysis.pdf_structure;
                    if (pdfStructure && pdfStructure.visual_proofs && pdfStructure.visual_proofs.length > 0) {
                        visualizationTitle = 'üìÑ PDF Modification Visual Proofs';
                        visualizationHtml = '<div class="viz-grid">';
                        pdfStructure.visual_proofs.forEach((proof, index) => {
                            if (proof.image) {
                                visualizationHtml += createImageElement(proof.image, `Visual Proof ${index + 1}`, proof.description || `Visual Proof ${index + 1}`);
                            }
                        });
                        visualizationHtml += '</div>';
                    }
                    // PDF: Priority 2 - DTD heatmap
                    else if (result.forensics.forensic_analysis.document_tampering?.visualizations?.heatmap) {
                        visualizationTitle = 'üìÑ Document Tampering Detection Heatmap';
                        const heatmap = result.forensics.forensic_analysis.document_tampering.visualizations.heatmap;
                        visualizationHtml = `<div class="viz-grid">${createImageElement(heatmap, 'DTD Heatmap', 'Tampering Heatmap')}</div>`;
                    }
                    // PDF: Priority 3 - PDF preview (if we have file_path or similar)
                    // TODO: Implement PDF preview if needed
                } else {
                    // IMAGE: Show heatmap
                    const dt = result.forensics.forensic_analysis.document_tampering;
                    if (dt && dt.visualizations && dt.visualizations.heatmap) {
                        visualizationTitle = 'üñºÔ∏è Document Analysis Heatmap';
                        visualizationHtml = `<div class="viz-grid">${createImageElement(dt.visualizations.heatmap, 'Heatmap', 'Tampering Heatmap')}</div>`;
                    }
                }

                if (visualizationHtml) {
                    html += `
                        <div class="card">
                            <div class="card-title">${visualizationTitle}</div>
                            ${visualizationHtml}
                        </div>
                    `;
                }
            }

            // 2. Main Decision Banner
            if (result.decision) {
                try {
                    const decision = result.decision;
                    const decisionClass = decision.decision || 'review';
                    const riskScore = decision.risk_score != null ? (decision.risk_score * 100).toFixed(1) : '0.0';
                    const confidence = decision.confidence != null ? (decision.confidence * 100).toFixed(0) : '0';

                    console.log('Rendering decision banner:', decisionClass, riskScore, confidence);

                    html += `
                        <div class="decision-banner ${decisionClass}">
                            <div class="decision-title">${getDecisionIcon(decisionClass)} ${decisionClass.toUpperCase()}</div>
                            <div class="decision-subtitle">${decision.decision_reason || 'No reason provided'}</div>
                            <div class="risk-score-container">
                                <div class="score-item">
                                    <div class="score-label">Risk Score</div>
                                    <div class="score-value">${riskScore}%</div>
                                </div>
                                <div class="score-item">
                                    <div class="score-label">Confidence</div>
                                    <div class="score-value">${confidence}%</div>
                                </div>
                                <div class="score-item">
                                    <div class="score-label">Document Format</div>
                                    <div class="score-value">${decision.document_format || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Key Indicators (inside decision block)
                    if (decision.key_indicators && decision.key_indicators.length > 0) {
                        html += '<div class="card"><div class="card-title">üö® Key Indicators</div>';
                        decision.key_indicators.forEach(indicator => {
                            html += `
                                <div class="indicator-card ${indicator.severity}">
                                    <div class="indicator-header">
                                        <div>
                                            <span class="badge ${indicator.severity}">${indicator.severity.toUpperCase()}</span>
                                            <span class="badge info">${indicator.type}</span>
                                        </div>
                                    </div>
                                    <div class="indicator-details">${indicator.message}</div>
                                </div>
                            `;
                        });
                        html += '</div>';
                    }

                    // Score Breakdown (inside decision block)
                    if (decision.score_breakdown) {
                        const sb = decision.score_breakdown;
                        html += `
                            <div class="card">
                                <div class="card-title">üìä Score Breakdown</div>
                                <div class="info-item">
                                    <div class="info-label">Forensic Score (Weight: ${sb.forensic_weight})</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${(sb.forensic_score * 100)}%">${(sb.forensic_score * 100).toFixed(1)}%</div>
                                    </div>
                                    <div class="info-value">Contribution: ${(sb.forensic_contribution * 100).toFixed(1)}%</div>
                                </div>
                                <div class="info-item" style="margin-top: 15px;">
                                    <div class="info-label">Deduplication Score (Weight: ${sb.deduplication_weight})</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${(sb.deduplication_score * 100)}%">${(sb.deduplication_score * 100).toFixed(1)}%</div>
                                    </div>
                                    <div class="info-value">Contribution: ${(sb.deduplication_contribution * 100).toFixed(1)}%</div>
                                </div>
                                <div class="grid-2" style="margin-top: 15px;">
                                    <div class="info-item">
                                        <div class="info-label">Accept Threshold</div>
                                        <div class="info-value">${(decision.thresholds_used.accept * 100).toFixed(0)}%</div>
                                    </div>
                                    <div class="info-item">
                                        <div class="info-label">Review Threshold</div>
                                        <div class="info-value">${(decision.thresholds_used.review * 100).toFixed(0)}%</div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                } catch (decisionError) {
                    console.error('Error rendering decision banner:', decisionError);
                }
            }

            // 3. Document Overview
            const processingTime = result.processing_time_ms != null ? (result.processing_time_ms / 1000).toFixed(2) + 's' : 'N/A';
            html += `
                <div class="card">
                    <div class="card-title">üìÑ Document Overview</div>
                    <div class="grid-2">
                        <div class="info-item">
                            <div class="info-label">Document ID</div>
                            <div class="info-value">${result.doc_id || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Timestamp</div>
                            <div class="info-value">${formatDate(result.timestamp)}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Processing Time</div>
                            <div class="info-value">${processingTime}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Pipeline Version</div>
                            <div class="info-value">${result.pipeline_version || 'N/A'}</div>
                        </div>
            `;

            if (result.routing) {
                const routingConfidence = result.routing.confidence != null ? (result.routing.confidence * 100).toFixed(0) : 'N/A';
                html += `
                        <div class="info-item">
                            <div class="info-label">Document Type</div>
                            <div class="info-value">${result.routing.doc_type || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Document Format</div>
                            <div class="info-value">${result.routing.document_format || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Country</div>
                            <div class="info-value">${result.routing.country || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Confidence</div>
                            <div class="info-value">${routingConfidence}${routingConfidence !== 'N/A' ? '%' : ''}</div>
                        </div>
                `;

                // Add extracted text if available
                if (result.routing.extracted_text) {
                    html += `
                        <div class="info-item" style="grid-column: 1 / -1; margin-top: 10px;">
                            <div class="expandable">
                                <div class="expandable-header" onclick="toggleExpandable(this)">
                                    <span>üìù Extracted Text</span>
                                    <span class="expandable-icon">‚ñº</span>
                                </div>
                                <div class="expandable-content">
                                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; font-family: 'Segoe UI', sans-serif; font-size: 13px; line-height: 1.6;">${result.routing.extracted_text}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            if (result.forensics && result.forensics.file_hash) {
                html += `
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <div class="info-label">File Hash (SHA256)</div>
                            <div class="hash-container">${result.forensics.file_hash}</div>
                        </div>
                `;
            }

            html += '</div></div>';

            // 4. AI Detection Results
            if (result.forensics && result.forensics.forensic_analysis && result.forensics.forensic_analysis.ai_detection) {
                const ai = result.forensics.forensic_analysis.ai_detection;
                const isAiGenerated = ai.is_ai_generated || ai.prediction === 1;
                const aiModel = ai.model_used || ai.model || 'N/A';
                const aiLabel = ai.binary_label || (isAiGenerated ? 'AI-GENERATED' : 'HUMAN-CREATED');

                html += `
                    <div class="card">
                        <div class="card-title">ü§ñ AI Detection</div>
                        <div class="indicator-card ${isAiGenerated ? 'high' : 'low'}">
                            <div class="indicator-header">
                                <div class="indicator-title">${aiLabel}</div>
                                <span class="badge ${isAiGenerated ? 'high' : 'low'}">${isAiGenerated ? 'AI-GENERATED' : 'HUMAN-CREATED'}</span>
                            </div>
                            <div class="indicator-details">Model: ${aiModel}</div>
                            ${ai.processing_time_ms ? `<div class="indicator-details">Processing Time: ${(ai.processing_time_ms / 1000).toFixed(2)}s</div>` : ''}
                        </div>
                    </div>
                `;
            }

            // 5. Suspicious Indicators
            if (result.forensics && result.forensics.suspicious_indicators && result.forensics.suspicious_indicators.length > 0) {
                html += '<div class="card"><div class="card-title">‚ö†Ô∏è Suspicious Indicators</div>';
                result.forensics.suspicious_indicators.forEach(indicator => {
                    const indicatorScore = indicator.score != null ? (indicator.score * 100).toFixed(1) : '0.0';
                    const indicatorWidth = indicator.score != null ? (indicator.score * 100) : 0;
                    html += `
                        <div class="expandable">
                            <div class="expandable-header" onclick="toggleExpandable(this)">
                                <div>
                                    <span class="badge ${indicator.severity || 'medium'}">${(indicator.severity || 'medium').toUpperCase()}</span>
                                    <span class="badge info">${indicator.type || 'Unknown'}</span>
                                    <span style="margin-left: 10px;">${indicator.details || 'No details'}</span>
                                </div>
                                <span class="expandable-icon">‚ñº</span>
                            </div>
                            <div class="expandable-content">
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${indicatorWidth}%">${indicatorScore}%</div>
                                </div>
                                ${indicator.evidence ? `<pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; font-size: 12px;">${JSON.stringify(indicator.evidence, null, 2)}</pre>` : '<p style="color: #999;">No evidence data available</p>'}
                            </div>
                        </div>
                    `;
                });
                html += '</div>';
            }

            resultsContent.innerHTML = html;
            results.classList.add('show');

            // Continue with more sections in next part
            addForensicAnalysisSection(result);
            addDeduplicationSection(result);
        }

        function getDecisionIcon(decision) {
            const icons = {
                'accept': '‚úÖ',
                'review': '‚ö†Ô∏è',
                'reject': '‚ùå'
            };
            return icons[decision] || 'üìã';
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            return new Date(timestamp).toLocaleString();
        }

        function toggleExpandable(header) {
            header.classList.toggle('active');
            const content = header.nextElementSibling;
            content.classList.toggle('active');
        }

        function cleanBase64(base64String) {
            if (!base64String) return '';
            // Remove any whitespace, newlines, etc.
            return base64String.replace(/\s/g, '');
        }

        function createImageElement(base64Data, altText, labelText) {
            if (!base64Data) return '';

            const cleanedBase64 = cleanBase64(base64Data);
            const imgId = 'img_' + Math.random().toString(36).substring(7);

            // Check if already has data URL prefix
            let imageDataUrl;
            if (cleanedBase64.startsWith('data:')) {
                // Already has the data URL prefix, use as-is
                imageDataUrl = cleanedBase64;
                console.log(`Image ${labelText}: Using existing data URL, size=${cleanedBase64.length} bytes`);
            } else {
                // Need to add prefix, detect format
                let format = 'png';
                if (cleanedBase64.startsWith('/9j/')) {
                    format = 'jpeg';
                } else if (cleanedBase64.startsWith('iVBORw0KGgo')) {
                    format = 'png';
                }
                imageDataUrl = `data:image/${format};base64,${cleanedBase64}`;
                console.log(`Image ${labelText}: Added ${format} prefix, size=${cleanedBase64.length} bytes`);
            }

            // Set the image source after DOM is ready to avoid HTML escaping issues
            setTimeout(() => {
                const img = document.getElementById(imgId);
                if (img) {
                    try {
                        img.src = imageDataUrl;
                    } catch (e) {
                        console.error(`Failed to set image src for ${labelText}:`, e);
                        img.style.display = 'none';
                        const errorDiv = img.parentElement.querySelector('.img-error');
                        if (errorDiv) errorDiv.style.display = 'block';
                    }
                }
            }, 0);

            return `
                <div class="viz-item">
                    <img id="${imgId}"
                         alt="${altText}"
                         onload="console.log('‚úì Loaded: ${labelText}');"
                         onerror="console.error('‚úó Failed: ${labelText}'); this.style.display='none'; this.parentElement.querySelector('.img-error').style.display='block';"
                         style="max-width: 100%; height: auto;">
                    <div class="viz-label">${labelText}</div>
                    <div class="img-error" style="display:none; color: #f44336; font-size: 12px; margin-top: 5px;">
                        Failed to load image<br>
                        Size: ${cleanedBase64.length} bytes
                    </div>
                </div>
            `;
        }

        function addForensicAnalysisSection(result) {
            if (!result.forensics || !result.forensics.forensic_analysis) return;

            const fa = result.forensics.forensic_analysis;
            let html = '<div class="card"><div class="card-title">üî¨ Detailed Forensic Analysis</div>';

            // Digital Print Detection
            if (fa.digital_print) {
                const dp = fa.digital_print;
                html += `
                    <div class="expandable">
                        <div class="expandable-header" onclick="toggleExpandable(this)">
                            <span>üñ®Ô∏è Digital Print Detection</span>
                            <span class="expandable-icon">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="indicator-card ${dp.is_digital_print ? 'high' : 'low'}">
                                <div class="indicator-header">
                                    <span class="indicator-title">Is Digital Print: ${dp.is_digital_print ? 'YES' : 'NO'}</span>
                                    <span class="badge ${dp.is_digital_print ? 'high' : 'low'}">Confidence: ${(dp.confidence * 100).toFixed(0)}%</span>
                                </div>
                                <div class="indicator-details">Method: ${dp.method || 'N/A'}</div>
                                <div class="indicator-details">Indicators: ${dp.indicators ? dp.indicators.join(', ') : 'None'}</div>
                            </div>
                            ${dp.vlm_analysis ? `
                                <div class="info-item" style="margin-top: 10px;">
                                    <div class="info-label">VLM Analysis</div>
                                    <div class="info-value">Digital Print: ${dp.vlm_analysis.is_digital_print ? 'Yes' : 'No'} (${(dp.vlm_analysis.confidence * 100).toFixed(0)}%)</div>
                                    <div style="margin-top: 5px; font-size: 13px; color: #666;">${dp.vlm_analysis.reasoning || ''}</div>
                                    ${dp.vlm_analysis.indicators ? `<div style="margin-top: 5px; font-size: 12px;">Indicators: ${dp.vlm_analysis.indicators.join(', ')}</div>` : ''}
                                </div>
                            ` : ''}
                            ${dp.exif_analysis ? `
                                <div class="info-item" style="margin-top: 10px;">
                                    <div class="info-label">EXIF Analysis</div>
                                    <div class="info-value">Digital Print: ${dp.exif_analysis.is_digital_print ? 'Yes' : 'No'} (${(dp.exif_analysis.confidence * 100).toFixed(0)}%)</div>
                                    ${dp.exif_analysis.metadata ? `
                                        <div style="margin-top: 5px;">
                                            <div style="font-size: 12px;">Format: ${dp.exif_analysis.metadata.format || 'N/A'}</div>
                                            <div style="font-size: 12px;">Size: ${dp.exif_analysis.metadata.size ? dp.exif_analysis.metadata.size.join('x') : 'N/A'}</div>
                                            <div style="font-size: 12px;">Mode: ${dp.exif_analysis.metadata.mode || 'N/A'}</div>
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Image Forensics
            if (fa.image_forensics) {
                const imf = fa.image_forensics;
                html += `
                    <div class="expandable">
                        <div class="expandable-header" onclick="toggleExpandable(this)">
                            <span>üñºÔ∏è Image Forensics</span>
                            <span class="expandable-icon">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="grid-2">
                                <div class="info-item">
                                    <div class="info-label">ELA Gap</div>
                                    <div class="info-value">${imf.ela_gap !== null ? imf.ela_gap : 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">JPEG Ghost Score</div>
                                    <div class="info-value">${imf.jpeg_ghost_score !== null ? imf.jpeg_ghost_score : 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Edge Anomaly</div>
                                    <div class="info-value">${imf.edge_anomaly ? 'Yes' : 'No'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Noise Outlier Ratio</div>
                                    <div class="info-value">${imf.noise_outlier_ratio ? (imf.noise_outlier_ratio * 100).toFixed(2) + '%' : 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Copy-Move Matches</div>
                                    <div class="info-value">${imf.copy_move_matches || 0}</div>
                                </div>
                            </div>
                            ${imf.font_analysis ? `
                                <div style="margin-top: 15px;">
                                    <div class="info-label">Font Analysis</div>
                                    <div class="grid-2" style="margin-top: 10px;">
                                        <div class="info-item">
                                            <div class="info-label">Total Fonts</div>
                                            <div class="info-value">${imf.font_analysis.total_fonts || 0}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Dominant Font</div>
                                            <div class="info-value">${imf.font_analysis.dominant_font || 'N/A'}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Consistency Score</div>
                                            <div class="info-value">${imf.font_analysis.consistency_score ? (imf.font_analysis.consistency_score * 100).toFixed(0) + '%' : 'N/A'}</div>
                                        </div>
                                        <div class="info-item">
                                            <div class="info-label">Suspicious Regions</div>
                                            <div class="info-value">${imf.font_analysis.suspicious_regions || 0}</div>
                                        </div>
                                    </div>
                                    ${imf.font_analysis.fraud_indicators && imf.font_analysis.fraud_indicators.length > 0 ? `
                                        <div style="margin-top: 10px;">
                                            <div class="info-label">Fraud Indicators</div>
                                            ${imf.font_analysis.fraud_indicators.map(ind => `
                                                <div class="indicator-card ${ind.severity}" style="margin-top: 5px;">
                                                    <span class="badge ${ind.severity}">${ind.type}</span>
                                                    <span style="margin-left: 10px;">${ind.message}</span>
                                                </div>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Document Tampering with Visualizations
            if (fa.document_tampering) {
                const dt = fa.document_tampering;
                html += `
                    <div class="expandable">
                        <div class="expandable-header" onclick="toggleExpandable(this)">
                            <span>üìù Document Tampering Detection</span>
                            <span class="expandable-icon">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="grid-2">
                                <div class="info-item">
                                    <div class="info-label">Model</div>
                                    <div class="info-value">${dt.model || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Quality Used</div>
                                    <div class="info-value">${dt.quality_used || 'N/A'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Processing Time</div>
                                    <div class="info-value">${dt.processing_time_ms ? (dt.processing_time_ms / 1000).toFixed(2) + 's' : 'N/A'}</div>
                                </div>
                            </div>
                            ${dt.visualizations ? `
                                <div style="margin-top: 20px;">
                                    <div class="info-label" style="margin-bottom: 15px;">Visualizations</div>
                                    <div class="viz-grid">
                                        ${createImageElement(dt.visualizations.original, 'Original Image', 'Original Image')}
                                        ${createImageElement(dt.visualizations.heatmap, 'Heatmap', 'Heatmap')}
                                        ${createImageElement(dt.visualizations.mask, 'Mask', 'Mask')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Character Variance
            if (fa.character_variance) {
                const cv = fa.character_variance;
                html += `
                    <div class="expandable">
                        <div class="expandable-header" onclick="toggleExpandable(this)">
                            <span>üî§ Character Variance Analysis</span>
                            <span class="expandable-icon">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="indicator-card ${cv.is_suspicious ? 'high' : 'low'}">
                                <div class="indicator-header">
                                    <span class="indicator-title">VLM Detected Fraud: ${cv.vlm_detected_fraud ? 'YES' : 'NO'}</span>
                                    <span class="badge ${cv.is_suspicious ? 'high' : 'low'}">${cv.is_suspicious ? 'SUSPICIOUS' : 'CLEAN'}</span>
                                </div>
                                ${cv.vlm_analysis && cv.vlm_analysis.reasoning ? `
                                    <div class="indicator-details" style="margin-top: 10px;">${cv.vlm_analysis.reasoning}</div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            resultsContent.insertAdjacentHTML('beforeend', html);
        }

        function addDeduplicationSection(result) {
            if (!result.deduplication) return;

            const dedup = result.deduplication;
            let html = '<div class="card"><div class="card-title">üîç Deduplication Analysis</div>';

            // Hashes
            if (dedup.hashes) {
                html += `
                    <div class="expandable">
                        <div class="expandable-header" onclick="toggleExpandable(this)">
                            <span>üîë File Hashes</span>
                            <span class="expandable-icon">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            ${dedup.hashes.sha256 ? `
                                <div class="info-item">
                                    <div class="info-label">SHA256</div>
                                    <div class="hash-container">${dedup.hashes.sha256}</div>
                                </div>
                            ` : ''}
                            ${dedup.hashes.image_hashes && dedup.hashes.image_hashes.length > 0 ? `
                                <div style="margin-top: 15px;">
                                    <div class="info-label">Image Hashes</div>
                                    <div class="grid-2" style="margin-top: 10px;">
                                        ${dedup.hashes.image_hashes.map(hash => `
                                            <div class="info-item">
                                                <div class="info-label">${hash.type.charAt(0).toUpperCase() + hash.type.slice(1)}</div>
                                                <div class="hash-container">${hash.hash}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            // Duplicates
            if (dedup.duplicates) {
                const totalDuplicates = (dedup.duplicates.exact?.length || 0) +
                                       (dedup.duplicates.fuzzy?.length || 0) +
                                       (dedup.duplicates.partial?.length || 0);

                html += `
                    <div class="expandable">
                        <div class="expandable-header" onclick="toggleExpandable(this)">
                            <span>üìã Duplicate Detection</span>
                            <span class="badge ${totalDuplicates > 0 ? 'high' : 'low'}">${totalDuplicates} Found</span>
                            <span class="expandable-icon">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="grid-2">
                                <div class="info-item">
                                    <div class="info-label">Exact Duplicates</div>
                                    <div class="info-value">${dedup.duplicates.exact?.length || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Fuzzy Duplicates</div>
                                    <div class="info-value">${dedup.duplicates.fuzzy?.length || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Partial Duplicates</div>
                                    <div class="info-value">${dedup.duplicates.partial?.length || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Deduplication Score</div>
                                    <div class="info-value">${dedup.deduplication_score != null ? (dedup.deduplication_score * 100).toFixed(1) + '%' : 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Online Duplicates
            if (dedup.online_duplicates) {
                const od = dedup.online_duplicates;
                html += `
                    <div class="expandable">
                        <div class="expandable-header" onclick="toggleExpandable(this)">
                            <span>üåê Online Duplicate Detection</span>
                            <span class="badge ${od.found_online ? 'high' : 'low'}">${od.found_online ? 'FOUND' : 'NOT FOUND'}</span>
                            <span class="expandable-icon">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="grid-2">
                                <div class="info-item">
                                    <div class="info-label">Found Online</div>
                                    <div class="info-value">${od.found_online ? 'Yes' : 'No'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Match Count</div>
                                    <div class="info-value">${od.match_count || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Search Date</div>
                                    <div class="info-value">${formatDate(od.search_date)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Fraud Network
            if (dedup.fraud_network) {
                const fn = dedup.fraud_network;
                const fnRiskScore = fn.risk_score != null ? fn.risk_score : 0;
                const fnRiskPercent = (fnRiskScore * 100).toFixed(0);
                const fnRiskLevel = fnRiskScore > 0.5 ? 'high' : fnRiskScore > 0.3 ? 'medium' : 'low';
                html += `
                    <div class="expandable">
                        <div class="expandable-header" onclick="toggleExpandable(this)">
                            <span>üï∏Ô∏è Fraud Network Analysis</span>
                            <span class="badge ${fnRiskLevel}">Risk: ${fnRiskPercent}%</span>
                            <span class="expandable-icon">‚ñº</span>
                        </div>
                        <div class="expandable-content">
                            <div class="grid-2">
                                <div class="info-item">
                                    <div class="info-label">Network ID</div>
                                    <div class="info-value">${fn.network_id || 'None'}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Connected Documents</div>
                                    <div class="info-value">${fn.connected_documents?.length || 0}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Network Risk Score</div>
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${fnRiskScore * 100}%">${(fnRiskScore * 100).toFixed(1)}%</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            html += '</div>';
            resultsContent.insertAdjacentHTML('beforeend', html);
        }

        function hideResults() {
            results.classList.remove('show');
        }

        function showError(message) {
            error.textContent = message;
            error.classList.add('show');
        }

        function hideError() {
            error.classList.remove('show');
        }

        function resetForm() {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.classList.remove('show');
            uploadBtn.classList.remove('show');
            hideResults();
            hideError();
        }
    </script>
</body>
</html>
